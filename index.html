<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Raheimâ€™s Problem Class</title>
<style>
:root { --primary:#1e3a8a; --secondary:#3b82f6; --light:#f8fafc; --shadow:rgba(0,0,0,0.1); --bubble-bg:#e0f2fe; --bubble-admin-bg:#bfdbfe; }
*{box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--light);margin:0;display:flex;flex-direction:column;min-height:100vh;}
header{background:var(--primary);color:white;padding:18px;font-size:1.8rem;font-weight:bold;text-align:center;box-shadow:0 2px 8px var(--shadow);}
#login{text-align:center;padding:20px;}
#main{flex:1;display:flex;flex-direction:column;overflow-y:auto;padding:10px;margin-bottom:160px;}
.post{max-width:80%;padding:10px 14px;border-radius:15px;margin:8px 0;background:var(--bubble-bg);word-wrap:break-word;box-shadow:0 2px 6px var(--shadow);animation:fadeIn .3s ease-in;}
.post.admin{background:var(--bubble-admin-bg);align-self:flex-end;}
.timestamp{font-size:0.75rem;color:#6b7280;margin-top:4px;text-align:right;}
img.post-img{max-width:100%;border-radius:10px;margin-top:6px;opacity:0;transition:opacity .4s;}
img.post-img.loaded{opacity:1;}
#symbolPanel{display:flex;flex-wrap:wrap;justify-content:center;padding:4px 10px;position:fixed;bottom:60px;width:100%;background:#f8fafc;z-index:100;}
#symbolPanel button{background:#e0f2fe;border:1px solid #bfdbfe;border-radius:8px;padding:6px 10px;margin:3px;font-size:1.1rem;cursor:pointer;transition:0.2s;}
#symbolPanel button:hover{background:#bfdbfe;}
#inputBar{position:fixed;bottom:0;left:0;width:100%;background:#f1f5f9;display:flex;align-items:center;padding:8px 10px;box-shadow:0 -2px 6px var(--shadow);z-index:100;}
#postText{flex:1;border-radius:25px;padding:10px 14px;border:1px solid #ccc;resize:none;font-size:1rem;outline-color:var(--secondary);max-height:80px;overflow-y:auto;transition:height .2s;}
#imageInput{display:none;}
#sendBtn,#menuBtn{margin-left:6px;border-radius:50%;border:none;padding:10px;cursor:pointer;font-size:1.2rem;background:var(--secondary);color:white;transition:0.2s;}
#sendBtn:hover,#menuBtn:hover{background:#2563eb;}
#menuDropdown{position:absolute;bottom:50px;right:10px;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px var(--shadow);display:none;flex-direction:column;min-width:160px;z-index:200;}
#menuDropdown button{background:none;color:var(--primary);border:none;padding:10px;text-align:left;width:100%;cursor:pointer;font-size:0.95rem;}
#menuDropdown button:hover{background:#f3f4f6;}
#floatImageBtn{position:fixed;bottom:120px;right:15px;background:var(--secondary);color:white;border-radius:50%;width:50px;height:50px;border:none;font-size:1.5rem;cursor:pointer;box-shadow:0 2px 6px var(--shadow);z-index:101;}
#floatImageBtn:hover{background:#2563eb;}
footer{text-align:center;padding:8px;font-size:0.8rem;color:#475569;}
@media(max-width:480px){#postText{font-size:0.9rem;}#sendBtn,#menuBtn{font-size:1rem;padding:8px;}#symbolPanel button{font-size:1rem;padding:5px 8px;}#floatImageBtn{width:45px;height:45px;font-size:1.3rem;}}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>
<header>ðŸ“˜ Raheimâ€™s Problem Class</header>

<div id="login">
  <h2>Welcome! Choose your role</h2>
  <button onclick="selectRole('User')">User</button>
  <button onclick="selectRole('MrPryce')">Mr. Pryce</button>
  <div id="passwordBox" style="display:none;">
    <p>Enter password for Mr. Pryce:</p>
    <input type="password" id="passwordInput" placeholder="Password" />
    <br/>
    <button onclick="loginAdmin()">Login</button>
  </div>
</div>

<div id="main" style="display:none;"></div>

<div id="symbolPanel">
  <button onclick="insertSymbol('âˆš')">âˆš</button>
  <button onclick="insertSymbol('Ï€')">Ï€</button>
  <button onclick="insertSymbol('Î”')">Î”</button>
  <button onclick="insertSymbol('Î¸')">Î¸</button>
  <button onclick="insertSymbol('âˆ‘')">âˆ‘</button>
  <button onclick="insertSymbol('âˆž')">âˆž</button>
  <button onclick="insertSymbol('Î¼')">Î¼</button>
</div>

<button id="floatImageBtn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>

<div id="inputBar">
  <textarea id="postText" placeholder="Type a problem..." oninput="autoGrow(this)"></textarea>
  <input type="file" id="imageInput" accept="image/*">
  <button id="sendBtn" onclick="addPost()">âž¤</button>
  <button id="menuBtn" onclick="toggleMenu()">â‹®</button>
  <div id="menuDropdown">
    <button onclick="downloadPDF()">ðŸ“„ Download All Problems</button>
    <button onclick="clearAll()">ðŸ§¹ Clear All Posts</button>
  </div>
</div>

<footer>Â© 2025 Raheimâ€™s Problem Class</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCjivkTeBcbr-UnnkfMbIYX7_9Wxya5U04",
  authDomain: "raheim-s-class.firebaseapp.com",
  databaseURL: "https://raheim-s-class-default-rtdb.firebaseio.com",
  projectId: "raheim-s-class",
  storageBucket: "raheim-s-class.appspot.com",
  messagingSenderId: "576992270609",
  appId: "1:576992270609:web:7441555f9299b8d42bd4b0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let role = null;
let autoScroll = true;

function selectRole(selected){
  role = selected;
  if(role === 'MrPryce') document.getElementById('passwordBox').style.display = 'block';
  else startApp();
}

function loginAdmin(){
  const pw = document.getElementById('passwordInput').value;
  if(pw === 'madkingpryce') startApp();
  else alert('Wrong password!');
}

function startApp(){
  document.getElementById('login').style.display = 'none';
  document.getElementById('main').style.display = 'flex';
  if(role !== 'MrPryce') document.getElementById('menuBtn').style.display = 'none';
  listenPosts();
}

function toggleMenu(){
  const menu = document.getElementById('menuDropdown');
  menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
}

function insertSymbol(sym){
  const txt = document.getElementById('postText');
  const start = txt.selectionStart;
  const end = txt.selectionEnd;
  txt.value = txt.value.substring(0,start) + sym + txt.value.substring(end);
  txt.focus();
  txt.selectionEnd = start + sym.length;
}

function autoGrow(el){
  el.style.height = "auto";
  el.style.height = (el.scrollHeight) + "px";
}

function addPost(){
  const text = document.getElementById('postText').value.trim();
  const fileInput = document.getElementById('imageInput');
  if(!text && !fileInput.files.length) return alert('Please add text or image.');

  const finalize = async (imgURL=null) => {
    const post = {text, time:new Date().toLocaleString(), admin: role==='MrPryce'};
    if(imgURL) post.img = imgURL;
    push(ref(db,'posts'), post);
    document.getElementById('postText').value='';
    document.getElementById('postText').style.height='auto';
    fileInput.value='';
  }

  if(fileInput.files.length){
    const file = fileInput.files[0];
    const storageRef = sRef(storage, 'images/'+Date.now()+'_'+file.name);
    uploadBytes(storageRef, file).then(snapshot=>{
      getDownloadURL(snapshot.ref).then(url => finalize(url));
    });
  } else finalize();
}

function listenPosts(){
  const main = document.getElementById('main');
  main.addEventListener('scroll',()=>{
    autoScroll = main.scrollTop + main.clientHeight >= main.scrollHeight - 50;
  });

  onValue(ref(db,'posts'), snapshot=>{
    const posts = [];
    snapshot.forEach(child=>posts.push(child.val()));
    posts.sort((a,b)=>new Date(a.time)-new Date(b.time));

    main.innerHTML='';
    posts.forEach(p=>{
      const div=document.createElement('div');
      div.className='post'+(p.admin?' admin':'');
      div.innerHTML=`<p>${p.text}</p>${p.img?`<img class="post-img" src="${p.img}">`:''}<div class="timestamp">${p.time}</div>`;
      main.appendChild(div);
      if(p.img){
        const img=div.querySelector('img');
        img.onload=()=>img.classList.add('loaded');
      }
    });
    if(autoScroll) main.scrollTop = main.scrollHeight;
  });
}

function clearAll(){
  if(role!=='MrPryce') return alert('Only Mr. Pryce can clear all posts.');
  if(confirm('Are you sure?')) remove(ref(db,'posts'));
}

async function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const snap = await new Promise(res => onValue(ref(db,'posts'), s=>res(s), {onlyOnce:true}));
  if(!snap.exists()) return alert('No posts to download.');

  const doc = new jsPDF();
  let y=15;
  doc.setFontSize(16);
  doc.text('Raheimâ€™s Problem Class - All Problems',10,y);
  y+=10;
  doc.setFontSize(12);

  const posts=[];
  snap.forEach(c=>posts.push(c.val()));
  posts.sort((a,b)=>new Date(a.time)-new Date(b.time));

  for(const p of posts){
    if(y>270){ doc.addPage(); y=15; }
    doc.text(`ðŸ•’ ${p.time}`,10,y); y+=6;
    const split=doc.splitTextToSize(p.text||'(No text)',180);
    doc.text(split,10,y); y+=split.length*6+4;
    if(p.img){
      try{ 
        const img = await fetch(p.img).then(r=>r.blob()).then(b=>new Promise(done=>{
          const reader=new FileReader(); reader.onload=()=>done(reader.result); reader.readAsDataURL(b);
        }));
        doc.addImage(img,'JPEG',10,y,60,60);
        y+=65;
      }catch{y+=5;}
    }
    y+=5;
  }
  doc.save('Raheims_Problem_Class.pdf');
}
</script>
</body>
</html>
