<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Raheim‚Äôs Problem Class</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --bg: #f8fafc;
    --text: #0f172a;
    --accent: #2563eb;
    --shadow: rgba(0,0,0,0.15);
  }
  body.dark {
    --bg: #0f172a;
    --text: #f8fafc;
    --accent: #60a5fa;
    --shadow: rgba(255,255,255,0.1);
    background: var(--bg);
    color: var(--text);
  }

  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--accent);
    color: white;
    padding: 10px 15px;
    box-shadow: 0 2px 6px var(--shadow);
  }

  #main {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 160px;
    position: relative;
    z-index: 1; /* ensures it stays behind input bar */
  }

  .post {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 5px var(--shadow);
    padding: 10px;
    margin-bottom: 10px;
  }
  body.dark .post { background: #1e293b; }

  .post.admin {
    border-left: 5px solid var(--accent);
  }

  .timestamp {
    font-size: 0.8em;
    opacity: 0.7;
  }

  .reaction-bar {
    display: flex;
    gap: 8px;
    margin-top: 5px;
  }
  .reaction-bar button {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1.2em;
  }

  #inputBar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    box-shadow: 0 -2px 6px var(--shadow);
    z-index: 200; /* fix: ensures typing area always on top */
  }
  body.dark #inputBar { background: #1e293b; }

  #postText {
    flex: 1;
    resize: none;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1em;
  }

  #sendBtn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 1em;
  }

  #login {
    margin: auto;
    text-align: center;
  }

  #passwordBox {
    display: none;
    margin-top: 10px;
  }

  #menuDropdown {
    display: none;
    flex-direction: column;
    background: white;
    position: absolute;
    top: 50px;
    right: 10px;
    box-shadow: 0 2px 6px var(--shadow);
    border-radius: 10px;
    overflow: hidden;
  }

  body.dark #menuDropdown { background: #1e293b; }

  #menuDropdown button {
    border: none;
    background: none;
    padding: 10px;
    text-align: left;
    cursor: pointer;
  }

  #symbolBar {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }

  .symbol {
    border: none;
    background: #e2e8f0;
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
  }

  body.dark .symbol { background: #334155; color: white; }
</style>
</head>
<body>

<header>
  <h2>Raheim‚Äôs Problem Class</h2>
  <div>
    <button id="menuBtn">‚ò∞</button>
    <button id="darkToggle">üåô</button>
  </div>
</header>

<div id="login">
  <h3>Sign in</h3>
  <button id="userBtn">User</button>
  <button id="pryceBtn">Mr. Pryce</button>
  <div id="passwordBox">
    <input type="password" id="passwordInput" placeholder="Password" />
    <button id="adminLoginBtn">Login</button>
  </div>
</div>

<div id="main" style="display:none;"></div>

<div id="inputBar">
  <div id="symbolBar">
    <button class="symbol">‚àö</button>
    <button class="symbol">œÄ</button>
    <button class="symbol">Œ∏</button>
    <button class="symbol">Œî</button>
    <button class="symbol">‚àû</button>
  </div>
  <textarea id="postText" rows="1" placeholder="Type your problem..."></textarea>
  <button id="sendBtn">Send</button>
</div>

<div id="menuDropdown">
  <button id="downloadBtn">üìÑ Download PDF</button>
  <button id="clearBtn">üóëÔ∏è Clear All</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCjivkTeBcbr-UnnkfMbIYX7_9Wxya5U04",
  authDomain: "raheim-s-class.firebaseapp.com",
  databaseURL: "https://raheim-s-class-default-rtdb.firebaseio.com",
  projectId: "raheim-s-class",
  storageBucket: "raheim-s-class.appspot.com",
  messagingSenderId: "576992270609",
  appId: "1:576992270609:web:7441555f9299b8d42bd4b0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let role = null;
let autoScroll = true;
const reactionOptions = ["‚úÖ", "‚ùå", "‚ù§Ô∏è"];

// üåô Dark Mode
const darkToggle = document.getElementById("darkToggle");
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
  darkToggle.textContent = "‚òÄÔ∏è";
}
darkToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  const dark = document.body.classList.contains("dark");
  darkToggle.textContent = dark ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("theme", dark ? "dark" : "light");
});

// Role selection
const userBtn = document.getElementById("userBtn");
const pryceBtn = document.getElementById("pryceBtn");
const adminLoginBtn = document.getElementById("adminLoginBtn");
const passwordBox = document.getElementById("passwordBox");

userBtn.addEventListener("click", () => {
  role = "User";
  startApp();
});

pryceBtn.addEventListener("click", () => {
  passwordBox.style.display = "block";
});

adminLoginBtn.addEventListener("click", () => {
  const pw = document.getElementById("passwordInput").value;
  if (pw === "madkingpryce") {
    role = "MrPryce";
    startApp();
  } else {
    alert("Wrong password!");
  }
});

function startApp() {
  document.getElementById("login").style.display = "none";
  const main = document.getElementById("main");
  main.style.display = "flex";
  if (role !== "MrPryce") document.getElementById("menuBtn").style.display = "none";
  listenPosts();
}

// Symbol insertion
document.querySelectorAll(".symbol").forEach(btn => {
  btn.addEventListener("click", () => {
    const sym = btn.textContent;
    const t = document.getElementById("postText");
    const start = t.selectionStart, end = t.selectionEnd;
    t.value = t.value.substring(0, start) + sym + t.value.substring(end);
    t.focus();
    t.selectionEnd = start + sym.length;
  });
});

// Auto-grow text area
const postText = document.getElementById("postText");
postText.addEventListener("input", () => {
  postText.style.height = "auto";
  postText.style.height = postText.scrollHeight + "px";
});

// Add post
document.getElementById("sendBtn").addEventListener("click", () => {
  const text = postText.value.trim();
  if (!text) return alert("Type something first!");
  const post = {
    text,
    time: new Date().toLocaleString(),
    admin: role === "MrPryce",
  };
  push(ref(db, "posts"), post);
  postText.value = "";
  postText.style.height = "auto";
});

// Listen for posts
function listenPosts() {
  const main = document.getElementById("main");
  main.addEventListener("scroll", () => {
    autoScroll = main.scrollTop + main.clientHeight >= main.scrollHeight - 50;
  });

  onValue(ref(db, "posts"), (snap) => {
    const posts = [];
    snap.forEach((c) => posts.push({ key: c.key, ...c.val() }));
    posts.sort((a, b) => new Date(a.time) - new Date(b.time));
    main.innerHTML = "";
    posts.forEach((p) => {
      const div = document.createElement("div");
      div.className = "post" + (p.admin ? " admin" : "");
      div.innerHTML = `
        <p>${p.text}</p>
        <div class='timestamp'>${p.time}</div>
        <div class='reaction-bar'>
          ${reactionOptions.map(r => `<button data-key="${p.key}" data-emoji="${r}">${r} ${(p.reactions && p.reactions[r]) ? p.reactions[r] : 0}</button>`).join('')}
        </div>`;
      main.appendChild(div);
    });
    if (autoScroll) main.scrollTop = main.scrollHeight;

    main.querySelectorAll(".reaction-bar button").forEach(btn => {
      btn.addEventListener("click", () => react(btn.dataset.key, btn.dataset.emoji));
    });
  });
}

// Reactions
function react(key, emoji) {
  const postRef = ref(db, "posts/" + key + "/reactions/" + emoji);
  onValue(postRef, (snap) => {
    let count = snap.exists() ? snap.val() : 0;
    count++;
    update(ref(db, "posts/" + key + "/reactions"), { [emoji]: count });
  }, { onlyOnce: true });
}

// Menu toggle
const menuBtn = document.getElementById("menuBtn");
const menuDropdown = document.getElementById("menuDropdown");
menuBtn.addEventListener("click", () => {
  menuDropdown.style.display = menuDropdown.style.display === "flex" ? "none" : "flex";
});

// Clear all posts
document.getElementById("clearBtn").addEventListener("click", () => {
  if (role !== "MrPryce") return alert("Only Mr. Pryce can clear all.");
  if (confirm("Delete all posts?")) remove(ref(db, "posts"));
});

// Download as PDF
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const snap = await new Promise((r) => onValue(ref(db, "posts"), (s) => r(s), { onlyOnce: true }));
  if (!snap.exists()) return alert("No posts.");
  const doc = new jsPDF();
  let y = 15;
  doc.setFontSize(16);
  doc.text("Raheim‚Äôs Problem Class", 10, y);
  y += 10;
  doc.setFontSize(12);
  const arr = [];
  snap.forEach((c) => arr.push(c.val()));
  arr.sort((a, b) => new Date(a.time) - new Date(b.time));
  for (const p of arr) {
    if (y > 270) { doc.addPage(); y = 15; }
    doc.text(`üïí ${p.time}`, 10, y);
    y += 6;
    const lines = doc.splitTextToSize(p.text || "(No text)", 180);
    doc.text(lines, 10, y);
    y += lines.length * 6 + 6;
  }
  doc.save("Raheims_Problem_Class.pdf");
});
</script>
</body>
</html>


