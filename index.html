<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ““ Live Class Notes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:#f0f4f8;display:flex;flex-direction:column;height:100vh;}
header{background:#1f2d3d;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;}
header .title{font-size:20px;font-weight:bold;}
header button{color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin-left:8px;}
.container{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.mainContent{flex:1;display:flex;overflow:hidden;position:relative;}
#toolbar{display:flex;flex-direction:column;gap:6px;background:#e0e7ff;padding:10px;min-width:80px;overflow-y:auto;transition: transform 0.3s ease;}
#toolbar.hidden{transform:translateX(-120%);}
#toolbar button{background:#4f46e5;color:#fff;border:none;padding:6px;border-radius:6px;cursor:pointer;font-size:18px;}
#toolbar button:hover{background:#3730a3;}
#btnClear{background:#ef4444;}
#editor{flex:1;background:#fff;padding:12px;overflow-y:auto;font-size:18px;line-height:1.5;white-space:pre-wrap;border-radius:10px;margin:4px;}
#editor.editable{border:2px solid green;padding:10px;}
#chatBox{border-top:2px solid #ccc;background:#fff;padding:10px;height:150px;overflow-y:auto;font-size:16px;}
#chatInput{display:flex;gap:8px;padding:8px;background:#e5e7eb;align-items:center;}
#chatInput input{flex:1;padding:10px;font-size:16px;border:1px solid #ccc;border-radius:6px;}
#chatInput button{background:#4f46e5;color:white;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;}
#chatInput button:hover{background:#3730a3;}
#emojiPicker{display:none;position:absolute;bottom:70px;right:20px;background:#fff;border:1px solid #ccc;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);max-width:250px;flex-wrap:wrap;z-index:1000;}
#emojiPicker button{font-size:20px;margin:4px;border:none;background:transparent;cursor:pointer;}
#chatLockDisplay{font-size:14px;color:#ef4444;font-weight:bold;padding:10px;text-align:center;display:none;}
#raiseHand{margin:8px 0;padding:8px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;}
#raisedList,#permissionList{font-size:14px;margin-top:5px;color:#111;display:flex;flex-direction:column;gap:6px;}
#raisedList div,#permissionList div{display:flex;gap:6px;align-items:center;position:relative;}
.allowBtn{background:#10b981;color:white;padding:3px 6px;border-radius:5px;border:none;cursor:pointer;}
.declineBtn{background:#ef4444;color:white;padding:3px 6px;border-radius:5px;border:none;cursor:pointer;}
.revokeBtn{background:#6b7280;color:white;padding:3px 6px;border-radius:5px;border:none;cursor:pointer;}
.admin-btn{margin-top:6px;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
#clearHandsBtn{display:none;background:#ef4444;color:white;}
#clearPermsBtn{display:none;background:#6b7280;color:white;}
#confettiCanvas{position:fixed;pointer-events:none;top:0;left:0;width:100%;height:100%;z-index:9999;}
#roleModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:999;}
.modalCard{background:#fff;padding:20px;border-radius:12px;max-width:400px;width:90%;}
.row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
.hidden-admin { display: none !important; }
</style>
</head>
<body>

<canvas id="confettiCanvas"></canvas>

<header>
Â  <div class="title">ğŸ““ Live Class Notes</div>
Â  <div>
Â  Â  <button id="toggleChatLock" style="display:none;background:#f59e0b;">ğŸ”’ Lock Chat</button>
Â  Â  <button id="toggleToolbar" style="display:none;background:#10b981;">â˜° Tools</button>
Â  </div>
</header>

<div class="container">
Â  <div class="mainContent">
Â  Â  <div id="toolbar" class="hidden">
Â  Â  Â  <button data-symbol="+">+</button>
Â  Â  Â  <button data-symbol="âˆ’">âˆ’</button>
Â  Â  Â  <button data-symbol="Ã—">Ã—</button>
Â  Â  Â  <button data-symbol="Ã·">Ã·</button>
Â  Â  Â  <button data-symbol="=">=</button>
Â  Â  Â  <button data-symbol="âˆš">âˆš</button>
Â  Â  Â  <button data-symbol="Ï€">Ï€</button>
Â  Â  Â  <button data-symbol="^">^</button>
Â  Â  Â  <button data-symbol="a/b">a/b</button>
Â  Â  Â  <button data-symbol="Î£">Î£</button>
Â  Â  Â  <button data-symbol="âˆ«">âˆ«</button>
Â  Â  Â  <button data-symbol="Î¸">Î¸</button>
Â  Â  Â  <button data-symbol="Î±">Î±</button>
Â  Â  Â  <button data-symbol="Î²">Î²</button>
Â  Â  Â  <button data-symbol="Î³">Î³</button>
Â  Â  Â  <button data-symbol="Î”">Î”</button>
Â  Â  Â  <button data-symbol="Î»">Î»</button>
Â  Â  Â  <button data-symbol="Î¼">Î¼</button>
Â  Â  Â  <button data-symbol="Ïƒ">Ïƒ</button>
Â  Â  Â  <button data-symbol="âˆ">âˆ</button>
Â  Â  Â  <button data-symbol="Â±">Â±</button>
Â  Â  Â  <button data-symbol="â‰¤">â‰¤</button>
Â  Â  Â  <button data-symbol="â‰¥">â‰¥</button>
Â  Â  Â  <button id="btnClear">ğŸ—‘ Clear</button>
Â  Â  </div>

Â  Â  <div style="flex:1;display:flex;flex-direction:column;">
Â  Â  Â  <div id="editor" contenteditable="false"><p style="color:#888;">Waiting for teacher...</p></div>
Â  Â  Â  <div id="yourPermission" style="font-weight:bold;color:green;margin:4px 0;"></div>

Â  Â  Â  <button id="raiseHand">ğŸ– Raise Hand</button>
Â  Â  Â  <h4>Raised Hands:</h4>
Â  Â  Â  <div id="raisedList"></div>
Â  Â  Â  <button id="clearHandsBtn" class="admin-btn">Clear Raised Hands</button>

Â  Â  Â  <h4>Board Permissions & Stars:</h4>
Â  Â  Â  <div id="permissionList"></div>
Â  Â  Â  <button id="clearPermsBtn" class="admin-btn">Revoke All Permissions</button>

Â  Â  Â  <div id="chatBox"></div>
Â  Â  Â  <div id="chatLockDisplay"></div>
Â  Â  Â  <div id="chatInput">
Â  Â  Â  Â  <input type="text" id="chatMessage" placeholder="Type a message..." autocorrect="off" autocomplete="off" spellcheck="false">
Â  Â  Â  Â  <button id="emojiBtn">ğŸ˜Š</button>
Â  Â  Â  Â  <button id="sendChat">Send</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="emojiPicker"></div>
Â  Â  </div>
Â  </div>
</div>

<div id="roleModal">
Â  <div class="modalCard">
Â  Â  <h3>Select role</h3>
Â  Â  <div class="row">
Â  Â  Â  <button id="btnTeacher">Teacher</button>
Â  Â  Â  <button id="btnStudent">Student</button>
Â  Â  </div>
Â  Â  <div id="pwBlock" style="display:none;margin-top:12px">
Â  Â  Â  <label>Password:</label>
Â  Â  Â  <input type="password" id="pwInput" placeholder="Enter password">
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <button id="btnEnter">Enter</button>
Â  Â  Â  Â  <button id="btnCancel">Cancel</button>
Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
Â  apiKey:"AIzaSyCjivkTeBcbr-UnnkfMbIYX7_9Wxya5U04",
Â  authDomain:"raheim-s-class.firebaseapp.com",
Â  databaseURL:"https://raheim-s-class-default-rtdb.firebaseio.com",
Â  projectId:"raheim-s-class",
Â  storageBucket:"raheim-s-class.firebasestorage.app",
Â  messagingSenderId:"576992270609",
Â  appId:"1:576992270609:web:7441555f9299b8d42bd4b0",
Â  measurementId:"G-MQZ68MPYH3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Variables
let isTeacher=false, userName="Student", userRole="Student";
const editor=document.getElementById('editor');
const toolbar=document.getElementById('toolbar');
const toggleToolbar=document.getElementById('toggleToolbar');
const toggleChatLock=document.getElementById('toggleChatLock');
const chatBox=document.getElementById('chatBox');
const chatInput=document.getElementById('chatInput');
const chatMsg=document.getElementById('chatMessage');
const chatLockDisplay=document.getElementById('chatLockDisplay');
const emojiPicker=document.getElementById('emojiPicker');
const raiseHandBtn=document.getElementById('raiseHand');
const raisedList=document.getElementById('raisedList');
const permissionList=document.getElementById('permissionList');
const yourPermission=document.getElementById('yourPermission');
const clearHandsBtn=document.getElementById('clearHandsBtn');
const clearPermsBtn=document.getElementById('clearPermsBtn');
const confettiCanvas=document.getElementById('confettiCanvas');
const TEACHER_PASSWORD="raheimp100classstarts";

// Utilities
function getProfileEmoji(name){
Â  if(name==="Teacher") return "ğŸ‘¨â€ğŸ«";
Â  // Use only the first part of the unique name for the hash
Â  const baseName = name.split('_')[0]; 
Â  const base=["âœ¨","ğŸš€","ğŸ’¡","ğŸ§ ","ğŸŒ±","ğŸ¦‰","ğŸ§©","ğŸŒŸ"], dec=["ğŸ’»","ğŸ“š","ğŸ“","ğŸ“","ğŸ”¬"];
Â  let hash=0;
Â  for(let i=0;i<baseName.length;i++) hash+=baseName.charCodeAt(i);
Â  return `${base[hash%base.length]}${dec[hash%dec.length]}`;
}
function launchConfetti(){
Â  const myConfetti=confetti.create(confettiCanvas,{resize:true,useWorker:true});
Â  myConfetti({particleCount:100,spread:70,origin:{y:0.6}});
}

// Load notes
db.ref('notes').on('value',snap=>{
Â  if(!isTeacher || editor.contentEditable==="false"){
Â  Â  const data=snap.val();
Â  Â  editor.innerHTML=data?.content||"";
Â  }
});

// Debounced editor updates 
let debounceTimer;
editor.addEventListener('input',()=>{
Â  clearTimeout(debounceTimer);
Â  debounceTimer = setTimeout(()=>{
Â  Â  if(isTeacher || editor.contentEditable==="true"){
Â  Â  Â  db.ref('notes').set({content:editor.innerHTML});
Â  Â  }
Â  },300); 
});

// Toolbar buttons
toolbar.querySelectorAll('button[data-symbol]').forEach(btn=>{
Â  btn.onclick=()=>{
Â  Â  if(!isTeacher && editor.contentEditable!=="true") return;
Â  Â  editor.innerHTML+=btn.getAttribute('data-symbol');
Â  Â  // Save immediately after button click
Â  Â  db.ref('notes').set({content:editor.innerHTML}); 
Â  };
});
document.getElementById('btnClear').onclick=()=>{if(isTeacher){editor.innerHTML='';db.ref('notes').set({content:""});}};
toggleToolbar.onclick=()=>{toolbar.classList.toggle('hidden');};

// Chat lock
db.ref('chatStatus').on('value', snap => {
Â  const isLocked = snap.val()===true;
Â  if(isLocked){
Â  Â  chatInput.style.display='none';
Â  Â  chatLockDisplay.style.display='block';
Â  Â  // FIX: Use <b> tags instead of Markdown ** for correct HTML rendering.
Â  Â  chatLockDisplay.innerHTML='ğŸš« Chat is currently <b>PAUSED</b> by the teacher.'; 
Â  }else{
Â  Â  chatLockDisplay.style.display='none';
Â  Â  chatInput.style.display='flex';
Â  }
Â  if(isTeacher){
Â  Â  toggleChatLock.textContent = isLocked?'ğŸ”“ Unlock Chat':'ğŸ”’ Lock Chat';
Â  Â  toggleChatLock.style.backgroundColor = isLocked?'#10b981':'#f59e0b';
Â  }
});
toggleChatLock.onclick=()=>{
Â  if(isTeacher){
Â  Â  db.ref('chatStatus').once('value', snap=>{
Â  Â  Â  const isLocked = snap.val()===true;
Â  Â  Â  db.ref('chatStatus').set(!isLocked);
Â  Â  });
Â  }
};

// Chat
function appendChat(msg){
Â  const div = document.createElement('div');
Â  const displayName = msg.userName.split('_')[0]; 
Â  div.innerHTML = `<b>${getProfileEmoji(msg.userName)} ${displayName}:</b> ${msg.text}`;
Â  
  // UX IMPROVEMENT: Check if user is near the bottom (within 50px tolerance) before auto-scrolling
Â  const atBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 50;
Â  
  chatBox.appendChild(div);
Â  
  if(atBottom) chatBox.scrollTop = chatBox.scrollHeight;
}
db.ref('chat').on('child_added', snap => appendChat(snap.val()));
function sendChat(){const text=chatMsg.value.trim();if(text){db.ref('chat').push({user:userRole,userName:userName,text:text});chatMsg.value='';}}
document.getElementById('sendChat').onclick=sendChat;
chatMsg.addEventListener('keypress',e=>{if(e.key==='Enter' && chatInput.style.display !== 'none') sendChat();});

// Emoji picker
const emojis=["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜­","ğŸ˜","ğŸ˜¡","ğŸ‘","ğŸ‘","ğŸ™","ğŸ”¥","ğŸ‰","â­","ğŸ’¯","ğŸ","ğŸ“š","âœï¸","ğŸ§®"];
emojis.forEach(e=>{
Â  const btn=document.createElement('button');
Â  btn.textContent=e;
Â  btn.onclick=()=>{chatMsg.value+=e;emojiPicker.style.display='none';chatMsg.focus();};
Â  emojiPicker.appendChild(btn);
});
document.getElementById('emojiBtn').onclick=()=>{emojiPicker.style.display=(emojiPicker.style.display==='none'?'flex':'none');};

// Raise Hand
raiseHandBtn.onclick=()=>{db.ref('raisedHands/'+userName).set(true);}
db.ref('raisedHands').on('value',snap=>{
Â  raisedList.innerHTML='';
Â  const data=snap.val()||{};
Â  Object.keys(data).forEach(name=>{
Â  Â  const row=document.createElement('div');
    const displayName = name.split('_')[0];
Â  Â  row.innerHTML=`${getProfileEmoji(name)} ${displayName}`;
Â  Â  if(isTeacher){
Â  Â  Â  const allowBtn=document.createElement('button');
Â  Â  Â  allowBtn.textContent='Allow'; allowBtn.className='allowBtn';
Â  Â  Â  allowBtn.onclick=()=>{db.ref('permissions/'+name).set(true);db.ref('raisedHands/'+name).remove();launchConfetti();}
Â  Â  Â  const declineBtn=document.createElement('button');
Â  Â  Â  declineBtn.textContent='Decline'; declineBtn.className='declineBtn';
Â  Â  Â  declineBtn.onclick=()=>db.ref('raisedHands/'+name).remove();
Â  Â  Â  row.append(allowBtn, declineBtn);
Â  Â  }
Â  Â  raisedList.appendChild(row);
Â  });
Â  clearHandsBtn.style.display=(isTeacher && Object.keys(data).length>0)?'inline-block':'none';
});
clearHandsBtn.onclick=()=>{if(isTeacher) db.ref('raisedHands').set({});}

// Permissions
db.ref("permissions").on("value",snap=>{
Â  permissionList.innerHTML='';
Â  const data=snap.val()||{};
Â  Object.keys(data).forEach(name=>{
Â  Â  const row=document.createElement("div");
    const displayName = name.split('_')[0];
Â  Â  row.innerHTML=`${getProfileEmoji(name)} <span class="star-student">${displayName} (Access)</span>`;
Â  Â  if(isTeacher){
Â  Â  Â  const revokeBtn=document.createElement("button");
Â  Â  Â  revokeBtn.textContent="Revoke"; revokeBtn.className="revokeBtn";
Â  Â  Â  revokeBtn.onclick=()=>db.ref("permissions/"+name).remove();
Â  Â  Â  row.append(revokeBtn);
Â  Â  }
Â  Â  permissionList.appendChild(row);
Â  });
Â  if(userName!=="Teacher"){
Â  Â  if(data[userName]){
        yourPermission.innerText="âœ… You have board access"; 
        editor.contentEditable="true"; 
        editor.classList.add('editable');
    }
Â  Â  else{
        yourPermission.innerText=""; 
        editor.contentEditable="false"; 
        editor.classList.remove('editable');
    }
Â  }
Â  clearPermsBtn.style.display=(isTeacher && Object.keys(data).length>0)?'inline-block':'none';
});
clearPermsBtn.onclick=()=>{if(isTeacher) db.ref("permissions").set({});}

// Role modal
const roleModal=document.getElementById('roleModal');
document.getElementById('btnTeacher').onclick=()=>{document.getElementById('pwBlock').style.display='block';};
document.getElementById('btnCancel').onclick=()=>{document.getElementById('pwBlock').style.display='none';};
document.getElementById('btnEnter').onclick=()=>{
Â  const pw=document.getElementById('pwInput').value;
Â  if(pw===TEACHER_PASSWORD){
Â  Â  isTeacher=true;userRole="Teacher";userName="Teacher";
Â  Â  toggleToolbar.style.display='inline-block';
Â  Â  toggleChatLock.style.display='inline-block';
Â  Â  toolbar.classList.remove('hidden');
Â  Â  editor.contentEditable='true'; editor.classList.add('editable');
Â  Â  roleModal.style.display='none'; chatInput.style.display='flex';
Â  Â  editor.innerHTML="<p>Start typing...</p>"; db.ref('notes').set({content:editor.innerHTML});
Â  } else alert("Wrong password");
};
document.getElementById('btnStudent').onclick=()=>{
Â  const namePrompt = prompt("Enter your name:")||"Student";
Â  // Unique Student Name: ensures no two students share a key in Firebase
Â  const baseName = namePrompt.trim().replace(/ /g, '_');
Â  userName = baseName + '_' + Math.floor(Math.random()*1000000); 
  
Â  isTeacher=false;userRole="Student";
Â  toggleToolbar.style.display='none'; toggleChatLock.style.display='none';
Â  toolbar.classList.add('hidden'); editor.contentEditable='false'; editor.classList.remove('editable');
Â  roleModal.style.display='none'; chatInput.style.display='flex';
};
</script>
</body>
</html>