<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RaheimsClassRoom</title>

<!-- KaTeX for math -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

<style>
:root {
  --primary: #1e40af;
  --background: #121212;
  --card-bg: #1e1e1e;
  --note-bg: #2a2a2a;
  --text: #e0e0e0;
  --radius: 8px;
  --spacing: 12px;
}
* { box-sizing:border-box; }
body {
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background: linear-gradient(-45deg, #1e40af, #9333ea, #f97316, #10b981);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  color: var(--text);
  overflow-x: hidden;
}
@keyframes gradientBG {
  0% {background-position:0% 50%;}
  50% {background-position:100% 50%;}
  100% {background-position:0% 50%;}
}
header { background:var(--primary); padding:20px; text-align:center; color:#fff; position:relative; overflow:hidden; z-index:1; }
h1 { margin:0; font-size:2em; }
main { max-width:1200px; margin:20px auto; display:grid; gap:20px; padding:0 var(--spacing); position:relative; z-index:1; }

.card { background:var(--card-bg); padding:var(--spacing); border-radius:var(--radius); box-shadow:0 4px 12px rgba(0,0,0,0.5); }
textarea,input { width:100%; padding:8px; margin:4px 0; border-radius:4px; border:none; background:#222; color:#fff; font-size:1rem; }
textarea { resize:none; }
button { cursor:pointer; border:none; border-radius:4px; padding:6px 12px; margin:2px; background:var(--primary); color:#fff; transition:0.2s; }
button:hover { transform:scale(1.05); background:#3b82f6; }
button:active { transform:scale(0.9); }
.avatar-btn.selected { border:2px solid #3b82f6; animation:pop 0.3s forwards; }
@keyframes pop{0%{transform:scale(0);}100%{transform:scale(1);}}

/* Feeds */
.note-feed, .chat-feed, .assign-feed, .announcement-feed, #raiseList {
  max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; padding:8px; border-radius:4px; background:var(--note-bg);
}
.note-card, .chat-message, .assign-card, .announce-card { 
  background:#1c1c1c; 
  padding:8px; 
  border-radius:6px; 
  opacity:0; 
  transform:translateY(20px); 
  transition:all 0.3s ease; 

  /* Wrapping fixes for long words/math symbols */
  word-wrap: break-word;      
  overflow-wrap: anywhere;     
  white-space: pre-wrap;      
}
.note-card.show, .chat-message.show, .assign-card.show, .announce-card.show { opacity:1; transform:translateY(0); }

.note-card .note-text {
  word-wrap: break-word;
  overflow-wrap: anywhere;
  white-space: pre-wrap;
}

/* KaTeX formula wrapping */
.katex, .katex-display {
  max-width: 100%;
  overflow-wrap: break-word;
  word-break: break-word;
}

.note-author, .chat-author { font-weight:bold; margin-right:4px; }

#mathSymbols { margin-top:6px; display:flex; flex-wrap:wrap; gap:4px; }
.symbol-button { opacity:0; transform: scale(0.3); transition: all 0.3s ease; }
.symbol-button.show { opacity:1; transform: scale(1); }

#chatInput, #noteText { transition:all 0.3s ease; }
#chatInput:focus, #noteText:focus { border:2px solid #3b82f6; }

.tabs { display:flex; gap:4px; margin-bottom:10px; overflow-x:auto; }
.tab-btn { flex:1; padding:6px; border-radius:4px; background:#333; color:#fff; cursor:pointer; text-align:center; white-space:nowrap; }
.tab-btn.active { background:var(--primary); }
.tab-content { display:none; }
.tab-content.active { display:block; }

/* Layout for notes+chat stacked on mobile */
.notes-chat-container { display:flex; flex-direction:column; gap:10px; }

@media(min-width:768px){
  main { grid-template-columns:1fr 1fr; }
  .notes-chat-container { flex-direction:column; }
}
@media(min-width:1024px){ main{ grid-template-columns:1fr 1fr 1fr; } }
</style>
</head>
<body>
<header>
<h1>RaheimsClassRoom</h1>
<p>Class Starts - let's learn!</p>
</header>

<main>
<!-- Login -->
<div id="loginCard" class="card">
<h2>Join the Class</h2>
<div>
<button onclick="pickRole('teacher')">Teacher üë®‚Äçüè´</button>
<button onclick="pickRole('student')">Student üéì</button>
</div>
<div id="teacherPass" style="display:none; margin-top:10px;">
<p>Enter code:</p>
<input type="password" id="passInput" placeholder="Secret code">
<p>Select avatar:</p>
<div id="teacherAvatars"></div>
<button id="enterTeacherBtn">Enter</button>
</div>
<div id="studentName" style="display:none; margin-top:10px;">
<p>Enter name:</p>
<input id="nameInput" placeholder="Your Name">
<p>Select avatar:</p>
<div id="studentAvatars"></div>
<button id="enterStudentBtn">Join</button>
</div>
</div>

<!-- Main Area -->
<div id="mainArea" style="display:none; grid-gap:20px;">

<!-- Tabs -->
<div class="tabs">
<button class="tab-btn active" data-tab="notesChatTab">Notes & Chat</button>
<button class="tab-btn" data-tab="assignTab">Assignments</button>
<button class="tab-btn" data-tab="announceTab">Announcements</button>
<button class="tab-btn" data-tab="raiseTab">Raise Hand</button>
</div>

<!-- Notes + Chat -->
<div id="notesChatTab" class="tab-content active card notes-chat-container">
  <div class="card">
    <h3>Notes Board</h3>
    <textarea id="noteText" rows="4" placeholder="Write a note..."></textarea>
    <div id="mathSymbols"></div>
    <div class="note-feed" id="notesBoard"></div>
    <button id="postNoteBtn">Post Note</button>
    <button id="clearNoteBtn" style="background:#dc3545; display:none;">Clear Notes</button>
  </div>
  <div class="card">
    <h3>Class Chat</h3>
    <div class="chat-feed" id="chatBox"></div>
    <input id="chatInput" placeholder="Type message...">
    <button id="emojiBtn">üòä</button>
    <button id="sendChatBtn">Send üí¨</button>
    <button id="clearChatBtn" style="background:#dc3545; display:none;">Clear Chat</button>
  </div>
</div>

<!-- Assignments -->
<div id="assignTab" class="tab-content card">
<h3>Assignments üìù</h3>
<div class="assign-feed" id="assignBoard"></div>
<button id="postAssignmentBtn" style="display:none;">Post Assignment</button>
</div>

<!-- Announcements -->
<div id="announceTab" class="tab-content card">
<h3>Announcements üì¢</h3>
<div class="announcement-feed" id="announcementBoard"></div>
<button id="postAnnouncementBtn" style="display:none;">Post Announcement</button>
</div>

<!-- Raise Hand -->
<div id="raiseTab" class="tab-content card">
<h3>Raise Hand ‚úã</h3>
<button id="raiseBtn">Raise Hand</button>
<div id="raiseList"></div>
<button id="clearRaiseBtn" style="background:#ffc107;color:#000; display:none;">Clear All Raises</button>
</div>

</div>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCjivsTeBcbr-UnnkfMbIYX7_9Wxya5U04",
  authDomain: "raheim-s-class.firebaseapp.com",
  databaseURL: "https://raheim-s-class-default-rtdb.firebaseio.com",
  projectId: "raheim-s-class",
  storageBucket: "raheim-s-class.appspot.com",
  messagingSenderId: "576992270609",
  appId: "1:576992270609:web:7441555f9299b8d42bd4b0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let role=null, name=null, avatar=null;
const TEACHER_CODE='raheimp100classstarts';
const DEBOUNCE_MS=1500;
let postDisabled=false, sendDisabled=false;
const mathSymbols=['\\pi','\\sqrt{}','\\infty','\\sum','\\div','\\neq','\\approx','\\theta','\\Delta','\\alpha','\\beta','\\gamma'];

const teacherAvatarOptions=['üë©‚Äçüè´','üë®‚Äçüè´','üßë‚Äçüè´'];
const studentAvatarOptions=['üòÄ','üòé','ü§ì','üßê','ü•≥','ü§©','üòá'];

// Setup avatars
function setupAvatars(){
  const tDiv=document.getElementById('teacherAvatars');
  teacherAvatarOptions.forEach(a=>{
    const b=document.createElement('button'); b.className='avatar-btn'; b.textContent=a;
    b.onclick=()=>{avatar=a; document.querySelectorAll('#teacherAvatars .avatar-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected');};
    tDiv.appendChild(b);
  });
  const sDiv=document.getElementById('studentAvatars');
  studentAvatarOptions.forEach(a=>{
    const b=document.createElement('button'); b.className='avatar-btn'; b.textContent=a;
    b.onclick=()=>{avatar=a; document.querySelectorAll('#studentAvatars .avatar-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected');};
    sDiv.appendChild(b);
  });
}
setupAvatars();

// Math symbols
const mathDiv=document.getElementById('mathSymbols');
mathSymbols.forEach((sym,i)=>{
  const b=document.createElement('button'); b.className='symbol-button'; b.textContent=sym;
  b.onclick=()=>insertSymbol(sym);
  mathDiv.appendChild(b);
  setTimeout(()=>b.classList.add('show'),i*100);
});
function insertSymbol(s){
  const t=document.getElementById('noteText');
  const start=t.selectionStart,end=t.selectionEnd,val=t.value;
  t.value=val.substring(0,start)+s+val.substring(end);
  t.focus(); t.selectionStart=t.selectionEnd=start+s.length;
}

// Login
function pickRole(r){
  role=r;
  document.getElementById('teacherPass').style.display='none';
  document.getElementById('studentName').style.display='none';
  if(r==='teacher') document.getElementById('teacherPass').style.display='block';
  else document.getElementById('studentName').style.display='block';
}

document.getElementById('enterTeacherBtn').onclick=()=>{
  const pw=document.getElementById('passInput').value;
  if(pw!==TEACHER_CODE){alert('Wrong code'); return;}
  if(!avatar){alert('Select avatar'); return;}
  name='Teacher'; startClass('teacher');
}

document.getElementById('enterStudentBtn').onclick=()=>{
  name=document.getElementById('nameInput').value.trim();
  if(!name){alert('Enter name'); return;}
  if(!avatar){alert('Select avatar'); return;}
  startClass('student');
}

// Start Class
function startClass(r){
  role=r;
  document.getElementById('loginCard').style.display='none';
  document.getElementById('mainArea').style.display='grid';

  // Role-based UI
  const postBtn=document.getElementById('postNoteBtn');
  const clearNoteBtn=document.getElementById('clearNoteBtn');
  const mathDiv=document.getElementById('mathSymbols');
  const clearChatBtn=document.getElementById('clearChatBtn');
  const clearRaiseBtn=document.getElementById('clearRaiseBtn');
  const postAssignBtn=document.getElementById('postAssignmentBtn');
  const postAnnounceBtn=document.getElementById('postAnnouncementBtn');

  if(r==='teacher'){
    postBtn.style.display='inline-block';
    clearNoteBtn.style.display='inline-block';
    mathDiv.style.display='flex';
    clearChatBtn.style.display='inline-block';
    clearRaiseBtn.style.display='inline-block';
    postAssignBtn.style.display='inline-block';
    postAnnounceBtn.style.display='inline-block';
    document.getElementById('raiseBtn').style.display='none';
    document.getElementById('noteText').disabled=false;
  } else {
    postBtn.style.display='none';
    clearNoteBtn.style.display='none';
    mathDiv.style.display='none';
    clearChatBtn.style.display='none';
    clearRaiseBtn.style.display='none';
    postAssignBtn.style.display='none';
    postAnnounceBtn.style.display='none';
    document.getElementById('raiseBtn').style.display='inline-block';
    document.getElementById('noteText').disabled=true;
  }

  listenNotes();
  listenChat();
  listenRaise();
  listenAssignments();
  listenAnnouncements();
}

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
  }
});

// Notes
document.getElementById('postNoteBtn').onclick=()=>{
  if(postDisabled) return;
  postDisabled=true; setTimeout(()=>postDisabled=false,DEBOUNCE_MS);
  const t=document.getElementById('noteText').value.trim();
  if(!t) return;
  db.ref('notes').push({text:t,name:name,avatar:avatar,time:Date.now()});
  document.getElementById('noteText').value='';
}

document.getElementById('clearNoteBtn').onclick=()=>{if(role==='teacher') db.ref('notes').remove();}

function createNoteEl(n){
  const div=document.createElement('div'); div.className='note-card';
  div.innerHTML=`<span class="note-author">${n.avatar} ${n.name}</span>: <span class="note-text"></span>`;
  setTimeout(()=>div.classList.add('show'),10);
  try { katex.render(n.text, div.querySelector('.note-text'), {throwOnError:false}); } catch { div.querySelector('.note-text').textContent=n.text; }
  return div;
}

function listenNotes(){
  const board=document.getElementById('notesBoard');
  db.ref('notes').orderByChild('time').on('child_added',snap=>{ board.appendChild(createNoteEl(snap.val())); board.scrollTop=board.scrollHeight; });
  db.ref('notes').on('child_removed',()=>{ board.innerHTML=''; });
}

// Chat
document.getElementById('sendChatBtn').onclick=()=>{
  if(sendDisabled) return; sendDisabled=true; setTimeout(()=>sendDisabled=false,DEBOUNCE_MS);
  const t=document.getElementById('chatInput').value.trim(); if(!t) return;
  db.ref('chat').push({name:name,avatar:avatar,text:t,time:Date.now()});
  document.getElementById('chatInput').value='';
}

document.getElementById('emojiBtn').onclick=()=>{document.getElementById('chatInput').value+='üòä';}
document.getElementById('clearChatBtn').onclick=()=>{if(role==='teacher') db.ref('chat').remove();}

function createChatEl(m){
  const div=document.createElement('div'); div.className='chat-message';
  const date=new Date(m.time).toLocaleTimeString();
  div.innerHTML=`${m.avatar} <span class="chat-author">${m.name}</span>: ${m.text} <small>${date}</small>`;
  setTimeout(()=>div.classList.add('show'),10); return div;
}

function listenChat(){
  const box=document.getElementById('chatBox');
  db.ref('chat').limitToLast(50).on('child_added',snap=>{ box.appendChild(createChatEl(snap.val())); box.scrollTop=box.scrollHeight; });
  db.ref('chat').on('child_removed',()=>{ box.innerHTML=''; });
}

// Raise Hand
document.getElementById('raiseBtn').onclick=()=>{
  const key=name.replace(/[.#$\[\]\/]/g,'_');
  const ref=db.ref('raises/'+key);
  ref.once('value').then(s=>{ s.exists()?ref.remove():ref.set({name:name,avatar:avatar,time:Date.now()}); });
}
document.getElementById('clearRaiseBtn').onclick=()=>{if(role==='teacher') db.ref('raises').remove();}

function listenRaise(){
  const list=document.getElementById('raiseList'); const elements={};
  db.ref('raises').orderByChild('time').on('child_added',snap=>{
    const r=snap.val(); const div=document.createElement('div'); div.textContent=`${r.avatar} ${r.name}`;
    if(role==='teacher'){ const ack=document.createElement('button'); ack.textContent='‚úî'; ack.onclick=()=>db.ref('raises/'+snap.key).remove(); div.appendChild(ack);}
    list.appendChild(div); elements[snap.key]=div; setTimeout(()=>div.classList.add('show'),10);
  });
  db.ref('raises').on('child_removed',snap=>{if(elements[snap.key]){ list.removeChild(elements[snap.key]); delete elements[snap.key]; }});
}

// Assignments
document.getElementById('postAssignmentBtn').onclick=()=>{
  const title=prompt('Assignment title:'); const desc=prompt('Description:'); const due=prompt('Due date (YYYY-MM-DD):');
  if(!title || !desc || !due) return;
  db.ref('assignments').push({title,desc,due,postedBy:name,avatar,time:Date.now()});
}

function listenAssignments(){
  const board=document.getElementById('assignBoard');
  db.ref('assignments').orderByChild('time').on('child_added',snap=>{
    const a=snap.val();
    const div=document.createElement('div'); div.className='assign-card';
    div.innerHTML=`${a.avatar} <strong>${a.postedBy}</strong>: ${a.title} - ${a.desc} <br><em>Due: ${a.due}</em>`;
    board.appendChild(div); setTimeout(()=>div.classList.add('show'),10);
  });
}

// Announcements
document.getElementById('postAnnouncementBtn').onclick=()=>{
  const text=prompt('Announcement text:'); if(!text) return;
  db.ref('announcements').push({text,postedBy:name,avatar,time:Date.now()});
}

function listenAnnouncements(){
  const board=document.getElementById('announcementBoard');
  db.ref('announcements').orderByChild('time').on('child_added',snap=>{
    const a=snap.val();
    const div=document.createElement('div'); div.className='announce-card';
    div.innerHTML=`${a.avatar} <strong>${a.postedBy}</strong>: ${a.text}`;
    board.appendChild(div); setTimeout(()=>div.classList.add('show'),10);
  });
}
</script>
</body>
</html>
