<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raheim‚Äôs Classroom Chat</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --bg: #f8fafc;
  --text: #0f172a;
  --accent: #2563eb;
  --accent-dark: #1e40af;
  --shadow: rgba(0,0,0,0.15);
  --input-bg: #e5e7eb;
  --font-base: 18px;
  --button-padding: 12px 20px;
  --border-radius: 12px;
}
body.dark {
  --bg: #0f172a;
  --text: #f8fafc;
  --accent: #60a5fa;
  --accent-dark: #2563eb;
  --shadow: rgba(255,255,255,0.1);
  --input-bg: #1e293b;
}
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
  font-size: var(--font-base);
  transition: background 0.3s, color 0.3s;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--accent);
  color: white;
  padding: 16px 20px;
  font-size: 1.4em;
  box-shadow: 0 2px 6px var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}
#login {
  margin: auto;
  text-align: center;
  padding: 50px 20px;
  font-size: 1.2em;
}
#passwordBox { display: none; margin-top: 12px; }
#main {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  padding: 12px;
  gap: 12px;
  min-height: 0;
  scroll-behavior: smooth;
}
.post {
  max-width: 90%;
  padding: 14px 16px;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 6px var(--shadow);
  position: relative;
  word-wrap: break-word;
  font-size: 1em;
}
body.dark .post { background: #1e293b; color: white; }
.post.user { background: #e5e7eb; margin-left: auto; }
body.dark .post.user { background: #334155; }
.post.admin { border-left: 4px solid var(--accent-dark); background: #fef3c7; margin-right: auto; }
body.dark .post.admin { background: #78350f; color: white; }
.timestamp { font-size: 0.8em; opacity: 0.6; margin-top: 4px; }
.reaction-bar { display: flex; gap: 8px; margin-top: 6px; }
.reaction-bar button { border: none; background: transparent; cursor: pointer; font-size: 1.2em; padding: 4px; }
#inputBar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: var(--input-bg);
  position: sticky;
  bottom: 0;
  z-index: 50;
}
#postText {
  flex: 1;
  resize: none;
  padding: 12px 16px;
  border-radius: 25px;
  border: none;
  font-size: 1em;
  outline: none;
  background: white;
}
body.dark #postText { background: #334155; color: white; }
#sendBtn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 25px;
  padding: var(--button-padding);
  cursor: pointer;
  font-size: 1em;
}
#symbolBar {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.symbol {
  border: none;
  background: #d1d5db;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1em;
}
body.dark .symbol { background: #475569; color: white; }
#menuDropdown {
  display: none;
  flex-direction: column;
  background: white;
  position: absolute;
  top: 60px;
  right: 10px;
  box-shadow: 0 2px 8px var(--shadow);
  border-radius: var(--border-radius);
  overflow: hidden;
  z-index: 1000;
}
body.dark #menuDropdown { background: #1e293b; }
#menuDropdown button {
  border: none;
  background: none;
  padding: 14px 16px;
  text-align: left;
  cursor: pointer;
  width: 160px;
  font-size: 1em;
}

/* Responsive adjustments */
@media (max-width: 800px) {
  header { font-size: 1.2em; padding: 14px 16px; }
  #postText { font-size: 0.95em; padding: 10px 14px; }
  .symbol { font-size: 0.95em; padding: 5px 8px; }
  #menuDropdown button { width: 140px; padding: 12px 14px; }
}
@media (max-width: 500px) {
  header { font-size: 1em; padding: 12px 14px; }
  #postText { font-size: 0.9em; }
  .symbol { font-size: 0.9em; }
  .reaction-bar button { font-size: 1em; }
}
</style>
</head>
<body>

<header>
  <h2>Raheim‚Äôs Classroom Chat</h2>
  <div>
    <button id="menuBtn" aria-label="Menu">‚ò∞</button>
    <button id="darkToggle" aria-label="Toggle Dark Mode">üåô</button>
  </div>
</header>

<div id="login">
  <h3>Sign in</h3>
  <button id="userBtn">User</button>
  <button id="pryceBtn">Mr. Pryce</button>
  <div id="passwordBox">
    <input type="password" id="passwordInput" placeholder="Password" />
    <button id="adminLoginBtn">Login</button>
  </div>
</div>

<div id="main" style="display:none;"></div>

<div id="inputBar">
  <div id="symbolBar">
    <button class="symbol">‚àö</button>
    <button class="symbol">œÄ</button>
    <button class="symbol">Œ∏</button>
    <button class="symbol">Œî</button>
    <button class="symbol">‚àû</button>
  </div>
  <textarea id="postText" rows="1" placeholder="Type your problem, question, or homework..."></textarea>
  <button id="sendBtn">Send</button>
</div>

<div id="menuDropdown">
  <button id="downloadBtn">üìÑ Download PDF</button>
  <button id="clearBtn">üóëÔ∏è Clear All</button>
</div>

<script type="module">
// Firebase setup (same as your previous code)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCjivkTeBcbr-UnnkfMbIYX7_9Wxya5U04",
  authDomain: "raheim-s-class.firebaseapp.com",
  databaseURL: "https://raheim-s-class-default-rtdb.firebaseio.com",
  projectId: "raheim-s-class",
  storageBucket: "raheim-s-class.appspot.com",
  messagingSenderId: "576992270609",
  appId: "1:576992270609:web:7441555f9299b8d42bd4b0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let role = null;
let autoScroll = true;
const reactionOptions = ["‚úÖ","‚ùå","‚ù§Ô∏è"];

// Dark mode
const darkToggle = document.getElementById("darkToggle");
if(localStorage.getItem("theme")==="dark"){document.body.classList.add("dark"); darkToggle.textContent="‚òÄÔ∏è";}
darkToggle.addEventListener("click",()=>{
  document.body.classList.toggle("dark");
  darkToggle.textContent=document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
  localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");
});

// Role selection
document.getElementById("userBtn").addEventListener("click",()=>{role="User"; startApp();});
document.getElementById("pryceBtn").addEventListener("click",()=>{document.getElementById("passwordBox").style.display="block";});
document.getElementById("adminLoginBtn").addEventListener("click",()=>{
  if(document.getElementById("passwordInput").value==="madkingpryce"){role="MrPryce"; startApp();}else{alert("Wrong password!");}
});

function startApp(){
  document.getElementById("login").style.display="none";
  const main=document.getElementById("main");
  main.style.display="flex"; main.style.flexDirection="column";
  if(role!=="MrPryce") document.getElementById("menuBtn").style.display="none";
  listenPosts();
}

// Symbols
document.querySelectorAll(".symbol").forEach(btn=>btn.addEventListener("click",()=>{
  const t=document.getElementById("postText"); const s=t.selectionStart; const e=t.selectionEnd; 
  t.value=t.value.substring(0,s)+btn.textContent+t.value.substring(e); t.focus(); t.selectionEnd=s+btn.textContent.length;
}));

// Auto-grow & Enter key
const postText=document.getElementById("postText");
postText.addEventListener("input",()=>{postText.style.height="auto"; postText.style.height=postText.scrollHeight+"px";});
postText.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); document.getElementById("sendBtn").click(); }
});

// Add post
document.getElementById("sendBtn").addEventListener("click",()=>{
  const text=postText.value.trim(); if(!text) return alert("Type something first!");
  const post={text,time:new Date().toLocaleString(),admin:role==="MrPryce",user:role==="User"};
  push(ref(db,"posts"),post); postText.value=""; postText.style.height="auto";
});

// Listen posts
function listenPosts(){
  const main=document.getElementById("main");
  main.addEventListener("scroll",()=>{autoScroll=main.scrollTop+main.clientHeight>=main.scrollHeight-50;});
  onValue(ref(db,"posts"),snap=>{
    const posts=[]; snap.forEach(c=>posts.push({key:c.key,...c.val()}));
    posts.sort((a,b)=>new Date(a.time)-new Date(b.time));
    main.innerHTML="";
    posts.forEach(p=>{
      const div=document.createElement("div");
      let cls="post "+(p.admin?"admin":"user");
      div.className=cls;
      div.innerHTML=`<p>${p.text}</p>
        <div class='timestamp'>${p.time}</div>
        <div class='reaction-bar'>
        ${reactionOptions.map(r=>`<button data-key="${p.key}" data-emoji="${r}">${r} ${(p.reactions&&p.reactions[r])?p.reactions[r]:0}</button>`).join('')}
        </div>`;
      main.appendChild(div);
    });
    if(autoScroll) main.scrollTop=main.scrollHeight;
    main.querySelectorAll(".reaction-bar button").forEach(btn=>btn.addEventListener("click",()=>runTransaction(ref(db,"posts/"+btn.dataset.key+"/reactions/"+btn.dataset.emoji),v=>(v||0)+1)));
  });
}

// Menu
const menuBtn=document.getElementById("menuBtn");
const menuDropdown=document.getElementById("menuDropdown");
menuBtn.addEventListener("click",()=>{menuDropdown.style.display=menuDropdown.style.display==="flex"?"none":"flex";});
document.addEventListener("click",e=>{if(!menuDropdown.contains(e.target)&&e.target!==menuBtn) menuDropdown.style.display="none";});

// Clear posts
document.getElementById("clearBtn").addEventListener("click",()=>{
  if(role!=="MrPryce") return alert("Only Mr. Pryce can clear all.");
  if(confirm("Delete all posts?")) remove(ref(db,"posts"));
});

// PDF download
document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const { jsPDF }=window.jspdf;
  const snap=await new Promise(r=>onValue(ref(db,"posts"),s=>r(s),{onlyOnce:true}));
  if(!snap.exists()) return alert("No posts.");
  const doc=new jsPDF(); let y=15;
  doc.setFontSize(16); doc.text("Raheim‚Äôs Classroom Chat",10,y); y+=10; doc.setFontSize(12);
  const arr=[]; snap.forEach(c=>arr.push(c.val())); arr.sort((a,b)=>new Date(a.time)-new Date(b.time));
  for(const p of arr){
    if(y>270){doc.addPage(); y=15;}
    doc.text(`üïí ${p.time}`,10,y); y+=6;
    const lines=doc.splitTextToSize(p.text||"(No text)",180);
    doc.text(lines,10,y); y+=lines.length*6+6;
  }
  doc.save("Raheims_Classroom_Chat.pdf");
});
</script>
</body>
</html>
