<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Raheim‚Äôs Interactive Classroom</title>

<style>
    :root {
        --primary-color: #2563eb; 
        --background-color: #f7f9fc;
        --card-background: #ffffff;
        --note-background: #eef2ff;
        --raise-background: #fff3cd; 
        --text-color: #333333;
        --border-radius: 10px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
    }

    header {
        background: var(--primary-color);
        color: var(--card-background);
        padding: 20px 0;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    header h1 {
        margin: 0;
        font-size: 1.8em;
    }

    main {
        max-width: 1200px;
        margin: var(--spacing-lg) auto;
        padding: 0 var(--spacing-md);
    }

    .card {
        background: var(--card-background);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* --- Form Elements and Buttons --- */
    textarea, input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #dcdfe4;
        border-radius: 6px;
        box-sizing: border-box;
        transition: border-color 0.2s;
    }

    textarea:focus, input:focus {
        border-color: var(--primary-color);
        outline: none;
    }

    button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        background: var(--primary-color);
        color: #fff;
        margin-right: 8px;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        font-weight: 600;
        white-space: nowrap; 
    }

    button:hover {
        background: #1e52c7;
    }

    button:disabled {
        background: #aaa;
        cursor: not-allowed;
    }

    /* --- Main Layout: CSS Grid for spacious, structured content --- */
    #mainArea {
        display: grid;
        grid-template-columns: 2fr 1fr; 
        gap: var(--spacing-lg); 
    }

    @media (max-width: 900px) {
        #mainArea {
            grid-template-columns: 1fr;
        }
    }

    /* --- Feature Specific Styles --- */
    .chat {
        max-height: 350px; 
        min-height: 150px;
        overflow-y: auto;
        background: #f0f2f5;
        padding: var(--spacing-md);
        border-radius: 6px;
        margin-bottom: var(--spacing-md);
        border: 1px solid #e0e0e0;
    }
    
    .chat div {
        margin-bottom: 8px;
        padding: 4px 0;
    }

    .note {
        background: var(--note-background);
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid var(--primary-color);
        font-size: 1.05em;
        white-space: pre-wrap;
        position: relative;
    }
    
    .note-meta {
        font-size: 0.8em;
        color: #666;
        display: block;
        margin-bottom: 4px;
    }

    .raise {
        background: var(--raise-background);
        padding: 10px;
        border-radius: 6px;
        margin: 8px 0;
        font-weight: 500;
        border: 1px solid #ffeb8f;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .raise button {
        background: #008000;
    }
    
    /* Login/Role Specific Spacing */
    #teacherPass, #studentName {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px dashed #e0e0e0;
    }

    .button-group {
        margin-top: 12px;
        display: flex;
        gap: 10px;
    }
</style>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
    <h1>Raheim‚Äôs Interactive Classroom</h1>
</header>

<main>
    <div id="loginCard" class="card">
        <h2>Welcome! Join the Class</h2>
        <div class="button-group">
            <button onclick="pickRole('teacher')">I‚Äôm a Teacher üë®‚Äçüè´</button>
            <button onclick="pickRole('student')">I‚Äôm a Student üéì</button>
        </div>

        <div id="teacherPass" style="display:none">
            <p>Enter teacher code:</p>
            <input type="password" id="passInput" placeholder="Enter secret code">
            <button onclick="enterTeacher()">Enter</button>
        </div>

        <div id="studentName" style="display:none">
            <p>Enter your name:</p>
            <input id="nameInput" placeholder="Your Name">
            <button onclick="enterStudent()">Join Class</button>
        </div>
    </div>

    <div id="mainArea" style="display:none">
        
        <div id="notes" class="card">
            <h3>Notes Board</h3>
            <div id="noteList"></div>
            
            <div id="teacherNoteBox" style="display:none">
                <textarea id="noteText" placeholder="Write a note to the class..." rows="8"></textarea>
                <button onclick="postNote()">Post New Note</button>
            </div>
        </div>

        <div>
            <div id="chat" class="card">
                <h3>Class Chat</h3>
                <div class="chat" id="chatBox"></div>
                
                <input id="chatInput" placeholder="Type message...">
                <div class="button-group">
                    <button onclick="sendMsg()">Send üí¨</button>
                    <button id="clearChatBtn" style="display:none; background:#dc3545;" onclick="clearChat()">Clear Chat</button>
                </div>
            </div>

            <div id="raise" class="card">
                <h3>Raise Hand ‚úã</h3>
                <button id="raiseBtn" onclick="raiseHand()">Raise Hand</button>
                <div id="raiseList" style="margin-top: 10px;"></div>
                
                <button id="clearRaiseBtn" style="display:none; background:#ffc107; color:#333;" onclick="clearRaise()">Clear All Raises</button>
            </div>
        </div>
    </div>
</main>

<script>
/* -------- Firebase setup -------- */
const firebaseConfig = {
    // IMPORTANT: Replace these with your actual keys from the Firebase Console
    apiKey: "AIzaSyCjivkTeBcbr-UnnkfMbIYX7_9Wxya5U04",
    authDomain: "raheim-s-class.firebaseapp.com",
    databaseURL: "https://raheim-s-class-default-rtdb.firebaseio.com",
    projectId: "raheim-s-class",
    storageBucket: "raheim-s-class.firebasestorage.app",
    messagingSenderId: "576992270609",
    appId: "1:576992270609:web:7441555f9299b8d42bd4b0",
    measurementId: "G-MQZ68MPYH3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------- Globals -------- */
let role = null;
let name = null;
const teacherStatusRef = db.ref('status/teacher');
const TEACHER_CODE = 'raheimp100classstarts'; // STILL INSECURE!

/* -------- Login -------- */
function pickRole(r){
    role = r;
    document.getElementById('teacherPass').style.display = 'none';
    document.getElementById('studentName').style.display = 'none';

    if(r === 'teacher'){
        document.getElementById('teacherPass').style.display = 'block';
    } else {
        document.getElementById('studentName').style.display = 'block';
    }
}

function enterTeacher(){
    const pw = document.getElementById('passInput').value;
    if(pw !== TEACHER_CODE){
        alert('Wrong code');
        return;
    }
    
    teacherStatusRef.get().then(s => {
        // Check if teacher status is active
        if(s.exists() && s.val().active){
            alert('A teacher is already active. Please refresh and try again later.');
        } else {
            // Set active status and set 'onDisconnect' to automatically clear it
            teacherStatusRef.set({active: true, time: Date.now()});
            teacherStatusRef.onDisconnect().set({active: false, time: 'Disconnected'});
            startClass('teacher');
        }
    }).catch(error => {
        alert("Error connecting to database. Check your Firebase rules and config.");
        console.error(error);
    });
}

function enterStudent(){
    name = document.getElementById('nameInput').value.trim();
    if(!name){
        alert('Enter your name to join!');
        return;
    }
    // Simple check to prevent duplicate names in the database for raises
    // In a real app, this would use unique UIDs from Firebase Auth
    db.ref('students/').push({name: name, time: Date.now()}).then(() => {
        startClass('student');
    });
}

/* -------- UI start -------- */
function startClass(r){
    role = r;
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('mainArea').style.display = 'grid'; 
    
    if(r === 'teacher'){
        document.getElementById('teacherNoteBox').style.display = 'block';
        document.getElementById('clearChatBtn').style.display = 'inline-block';
        document.getElementById('clearRaiseBtn').style.display = 'inline-block';
        document.getElementById('raiseBtn').style.display = 'none';
    } else {
        document.getElementById('teacherNoteBox').style.display = 'none';
        document.getElementById('clearChatBtn').style.display = 'none';
        document.getElementById('clearRaiseBtn').style.display = 'none';
        document.getElementById('raiseBtn').style.display = 'inline-block';
    }
    
    listenNotes();
    listenChat();
    listenRaise();
}

/* -------- Notes -------- */
function postNote(){
    const t = document.getElementById('noteText').value.trim();
    if(!t) return;
    // Pushing a new note with a username for better tracking
    db.ref('notes').push({text: t, name: 'Teacher', time: Date.now()});
    document.getElementById('noteText').value = '';
}
function listenNotes(){
    db.ref('notes').on('value', snap => {
        const d = snap.val() || {};
        const list = document.getElementById('noteList');
        list.innerHTML = '';
        
        const notesArray = Object.values(d).sort((a, b) => b.time - a.time);
        
        notesArray.forEach(n => {
            const div = document.createElement('div');
            div.className = 'note';
            const timeStr = new Date(n.time).toLocaleTimeString();
            
            // Display sender name (Teacher) and time
            div.innerHTML = `<span class="note-meta">Posted by ${n.name} at ${timeStr}</span>${n.text}`;
            list.appendChild(div);
        });
    });
}

/* -------- Chat -------- */
function sendMsg(){
    const t = document.getElementById('chatInput').value.trim();
    if(!t) return;
    const senderName = role === 'teacher' ? 'Teacher' : (name || 'Student');
    db.ref('chat').push({name: senderName, text: t, time: Date.now()});
    document.getElementById('chatInput').value = '';
}
function listenChat(){
    db.ref('chat').on('value', snap => {
        const d = snap.val() || {};
        const box = document.getElementById('chatBox');
        box.innerHTML = '';
        
        const chatArray = Object.values(d).sort((a, b) => a.time - b.time);

        chatArray.forEach(m => {
            const div = document.createElement('div');
            const timeStr = new Date(m.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            if (m.name === 'Teacher') {
                 div.innerHTML = `<strong style="color: var(--primary-color);">${m.name} (${timeStr}):</strong> ${m.text}`;
            } else {
                 div.innerHTML = `(${timeStr}) <strong>${m.name}:</strong> ${m.text}`;
            }
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    });
}
function clearChat(){
    if (role === 'teacher' && confirm("Are you sure you want to clear the entire chat history?")) {
        db.ref('chat').remove();
    }
}

/* -------- Raise hand -------- */
function raiseHand(){
    // Check if hand is already raised
    if (document.getElementById('raiseBtn').disabled) return;
    
    // Use the student's name as the key for raises to prevent duplicates by the same user
    const studentNameKey = (name || 'Guest').replace(/[.#$[\]]/g, ''); 
    
    db.ref('raises/' + studentNameKey).set({
        name: name || 'Student', 
        time: Date.now()
    }).then(() => {
        document.getElementById('raiseBtn').disabled = true;
        document.getElementById('raiseBtn').textContent = 'Hand Raised (Awaiting Acknowledge)';
    });
}

function listenRaise(){
    db.ref('raises').on('value', snap => {
        const d = snap.val() || {};
        const list = document.getElementById('raiseList');
        list.innerHTML = '';
        
        const raisesArray = Object.keys(d).map(key => ({...d[key], key: key})).sort((a, b) => a.time - b.time);

        raisesArray.forEach(r => {
            const div = document.createElement('div');
            div.className = 'raise';
            div.textContent = `${r.name}`;
            
            // Teacher-specific clear button for individual students
            if (role === 'teacher') {
                const clearOneBtn = document.createElement('button');
                clearOneBtn.textContent = 'Acknowledge';
                clearOneBtn.style.marginLeft = '10px';
                clearOneBtn.style.padding = '4px 8px';
                clearOneBtn.style.fontSize = '0.9em';
                clearOneBtn.onclick = () => acknowledgeRaise(r.key);
                div.appendChild(clearOneBtn);
            }
            list.appendChild(div);
        });
        
        // Student logic: check if their hand is still raised
        if (role === 'student') {
            const studentNameKey = (name || 'Guest').replace(/[.#$[\]]/g, '');
            const btn = document.getElementById('raiseBtn');
            
            // If the student's key is NOT in the database list, re-enable the button
            if (!d.hasOwnProperty(studentNameKey)) {
                btn.disabled = false;
                btn.textContent = 'Raise Hand';
            }
        }
    });
}

function acknowledgeRaise(key) {
    // Teacher clears a single raise
    if (role === 'teacher') {
        db.ref('raises/' + key).remove();
    }
}

function clearRaise(){
    if (role === 'teacher' && confirm("Are you sure you want to clear ALL raised hands?")) {
        db.ref('raises').remove();
    }
}
</script>
</body>
</html>